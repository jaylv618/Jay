<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综合设备调试工具 - HID/Modbus/DFU</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2d388a, #4a4b8c);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: rgba(30, 35, 80, 0.5);
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: rgba(60, 65, 120, 0.7);
        }
        
        .tab.active {
            background: rgba(78, 84, 200, 0.8);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(30, 35, 80, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4e54c8;
        }
        
        .panel-title i {
            margin-right: 10px;
            color: #6c7bff;
        }
        
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 500;
            word-break: break-all;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: linear-gradient(to right, #4e54c8, #6c7bff);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 84, 200, 0.4);
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(78, 84, 200, 0.6);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-disconnect {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }
        
        .btn-serial {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        
        .btn-dfu {
            background: linear-gradient(to right, #8e2de2, #4a00e0);
        }
        
        .btn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
        }
        
        textarea {
            height: 150px;
            font-family: monospace;
            resize: vertical;
        }
        
        .hex-input {
            font-family: monospace;
        }
        
        .command-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            display: flex;
        }
        
        .history-time {
            opacity: 0.7;
            margin-right: 15px;
            min-width: 70px;
        }
        
        .history-data {
            word-break: break-all;
        }
        
        .received-data {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .status {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 50px;
            background: rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        .status-disconnected {
            background: #f44336;
        }
        
        .status-pending {
            background: #ff9800;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: rgba(40, 40, 40, 0.9);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification-success {
            border-left: 5px solid #4caf50;
        }
        
        .notification-error {
            border-left: 5px solid #f44336;
        }
        
        .notification-warning {
            border-left: 5px solid #ff9800;
        }
        
        .notification-info {
            border-left: 5px solid #2196F3;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .troubleshooting {
            background: rgba(200, 50, 50, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #ff5252;
        }
        
        .troubleshooting h3 {
            color: #ff9e9e;
            margin-bottom: 10px;
        }
        
        .troubleshooting ul {
            padding-left: 20px;
        }
        
        .troubleshooting li {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .error-details {
            background: rgba(255, 82, 82, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .modbus-command {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .modbus-command-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modbus-command-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .modbus-params {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .modbus-response {
            background: rgba(0, 100, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
        }
        
        .serial-port-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .serial-port-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: background 0.2s;
        }
        
        .serial-port-item:hover {
            background: rgba(78, 84, 200, 0.3);
        }
        
        .serial-port-item.active {
            background: rgba(78, 84, 200, 0.5);
            font-weight: 500;
        }
        
        .dfu-progress-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }
        
        .dfu-progress-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .dfu-progress {
            height: 100%;
            background: linear-gradient(to right, #00b09b, #96c93d);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
        }
        
        .dfu-file-info {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .dfu-flash-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .dfu-command {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
        }
        
        .dfu-memory-info {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .dfu-memory-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .dfu-memory-name {
            font-weight: 500;
        }
        
        .dfu-memory-value {
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tools"></i> 综合设备调试工具</h1>
            <p class="subtitle">USB HID / 串口Modbus / DFU固件升级 - 基于WebHID, WebSerial和WebUSB API</p>
        </header>
        
        <div class="tab-container">
            <div class="tab active" data-tab="hid">USB HID调试</div>
            <div class="tab" data-tab="modbus">串口Modbus调试</div>
            <div class="tab" data-tab="dfu">DFU固件升级</div>
        </div>
        
        <!-- HID调试面板 -->
        <div id="hid-tab" class="tab-content active">
            <!-- 原有HID内容保持不变 -->
            <!-- ... -->
        </div>
        
        <!-- Modbus调试面板 -->
        <div id="modbus-tab" class="tab-content">
            <!-- 原有Modbus内容保持不变 -->
            <!-- ... -->
        </div>
        
        <!-- DFU固件升级面板 -->
        <div id="dfu-tab" class="tab-content">
            <div class="content">
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-microchip"></i> DFU设备连接</h2>
                    
                    <div class="device-info">
                        <div class="info-item">
                            <div class="info-label">连接状态</div>
                            <div class="info-value" id="dfu-status">未连接</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">设备名称</div>
                            <div class="info-value" id="dfu-device-name">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">厂商ID (VID)</div>
                            <div class="info-value" id="dfu-vendor-id">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">产品ID (PID)</div>
                            <div class="info-value" id="dfu-product-id">-</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="dfu-interface-alt">接口备用设置 (Alternate Setting)</label>
                        <input type="number" id="dfu-interface-alt" min="0" max="255" value="0">
                    </div>
                    
                    <div class="btn-container">
                        <button id="dfu-connect-btn" class="btn btn-dfu"><i class="fas fa-plug"></i> 连接DFU设备</button>
                        <button id="dfu-disconnect-btn" class="btn btn-disconnect"><i class="fas fa-unplug"></i> 断开连接</button>
                        <button id="dfu-detect-btn" class="btn"><i class="fas fa-search"></i> 检测DFU模式</button>
                    </div>
                    
                    <div class="status">
                        <div class="status-dot" id="dfu-status-dot"></div>
                        <span id="dfu-status-text">准备连接DFU设备...</span>
                    </div>
                    
                    <div class="dfu-memory-info">
                        <h3><i class="fas fa-memory"></i> 存储器信息</h3>
                        <div class="dfu-memory-row">
                            <span class="dfu-memory-name">Flash起始地址:</span>
                            <span class="dfu-memory-value" id="dfu-flash-start">0x08000000</span>
                        </div>
                        <div class="dfu-memory-row">
                            <span class="dfu-memory-name">Flash大小:</span>
                            <span class="dfu-memory-value" id="dfu-flash-size">512 KB</span>
                        </div>
                        <div class="dfu-memory-row">
                            <span class="dfu-memory-name">页大小:</span>
                            <span class="dfu-memory-value" id="dfu-page-size">2 KB</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-upload"></i> 固件升级</h2>
                    
                    <div class="form-group">
                        <label for="dfu-flash-address">Flash起始地址 (十六进制)</label>
                        <input type="text" id="dfu-flash-address" class="hex-input" value="0x08000000">
                    </div>
                    
                    <div class="form-group">
                        <label for="dfu-file">固件文件 (.bin/.hex/.dfu)</label>
                        <input type="file" id="dfu-file" accept=".bin,.hex,.dfu">
                    </div>
                    
                    <div class="dfu-file-info" id="dfu-file-info">
                        未选择文件
                    </div>
                    
                    <div class="dfu-flash-options">
                        <div class="form-group">
                            <label for="dfu-erase-type">擦除类型</label>
                            <select id="dfu-erase-type">
                                <option value="full">全片擦除</option>
                                <option value="sector" selected>按扇区擦除</option>
                                <option value="none">不擦除</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="dfu-chunk-size">传输块大小 (字节)</label>
                            <input type="number" id="dfu-chunk-size" min="32" max="65536" value="1024">
                        </div>
                    </div>
                    
                    <div class="btn-container">
                        <button id="dfu-upload-btn" class="btn btn-dfu"><i class="fas fa-upload"></i> 上传固件</button>
                        <button id="dfu-verify-btn" class="btn"><i class="fas fa-check"></i> 验证固件</button>
                        <button id="dfu-reset-btn" class="btn"><i class="fas fa-power-off"></i> 复位设备</button>
                    </div>
                    
                    <div class="dfu-progress-container">
                        <div>升级进度</div>
                        <div class="dfu-progress-bar">
                            <div class="dfu-progress" id="dfu-progress">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-terminal"></i> DFU控制命令</h2>
                    
                    <div class="btn-container">
                        <button id="dfu-get-status-btn" class="btn"><i class="fas fa-info-circle"></i> 获取状态</button>
                        <button id="dfu-abort-btn" class="btn"><i class="fas fa-stop-circle"></i> 中止操作</button>
                        <button id="dfu-clear-status-btn" class="btn"><i class="fas fa-broom"></i> 清除状态</button>
                    </div>
                    
                    <div class="dfu-command">
                        <div class="form-group">
                            <label for="dfu-command">DFU命令</label>
                            <select id="dfu-command">
                                <option value="0x00">DFU_DETACH</option>
                                <option value="0x01">DFU_DNLOAD</option>
                                <option value="0x02">DFU_UPLOAD</option>
                                <option value="0x03">DFU_GETSTATUS</option>
                                <option value="0x04">DFU_CLRSTATUS</option>
                                <option value="0x05">DFU_GETSTATE</option>
                                <option value="0x06">DFU_ABORT</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="dfu-command-data">命令数据 (十六进制, 空格分隔)</label>
                            <input type="text" id="dfu-command-data" class="hex-input" placeholder="可选数据">
                        </div>
                        
                        <button id="dfu-send-command-btn" class="btn"><i class="fas fa-paper-plane"></i> 发送命令</button>
                    </div>
                    
                    <div class="received-data" id="dfu-received-data">
等待DFU响应...
                    </div>
                </div>
                
                <div class="panel">
                    <h2 class="panel-title"><i class="fas fa-info-circle"></i> DFU信息</h2>
                    
                    <div class="code-block">
// DFU协议说明:
// 1. 设备必须处于DFU模式
// 2. 典型升级流程:
//    - 连接设备
//    - 选择固件文件
//    - (可选) 擦除Flash
//    - 上传固件
//    - 验证固件
//    - 复位设备
//
// 支持的DFU模式:
// - STM32 DFU
// - Atmel DFU
// - Nordic DFU
// - 通用DFU设备
                    </div>
                    
                    <div class="troubleshooting">
                        <h3><i class="fas fa-tools"></i> DFU常见问题</h3>
                        <ul>
                            <li>确保设备已进入DFU模式</li>
                            <li>检查VID/PID是否匹配</li>
                            <li>验证Flash地址是否正确</li>
                            <li>尝试不同的备用设置(Alternate Setting)</li>
                            <li>检查USB连接是否稳定</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>基于 WebHID / WebSerial / WebUSB API 技术 | 仅支持 Chrome 89+ 或 Edge 89+ 浏览器</p>
            <p>注意：首次连接需要用户授权，请确保您的设备支持相应协议</p>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // =============================================
        // 全局变量和DOM元素
        // =============================================
        // ... (保留之前的全局变量)
        
        // DFU相关变量
        let dfuDevice = null;
        let dfuInterface = null;
        let dfuConfiguration = null;
        let dfuFile = null;
        let dfuFileArrayBuffer = null;
        let dfuTransferSize = 1024;
        let dfuProgress = 0;
        let dfuState = 'dfuIDLE';
        
        // DFU相关DOM元素
        const dfuConnectBtn = document.getElementById('dfu-connect-btn');
        const dfuDisconnectBtn = document.getElementById('dfu-disconnect-btn');
        const dfuDetectBtn = document.getElementById('dfu-detect-btn');
        const dfuStatus = document.getElementById('dfu-status');
        const dfuDeviceName = document.getElementById('dfu-device-name');
        const dfuVendorId = document.getElementById('dfu-vendor-id');
        const dfuProductId = document.getElementById('dfu-product-id');
        const dfuStatusText = document.getElementById('dfu-status-text');
        const dfuStatusDot = document.getElementById('dfu-status-dot');
        const dfuFileInput = document.getElementById('dfu-file');
        const dfuFileInfo = document.getElementById('dfu-file-info');
        const dfuProgressBar = document.getElementById('dfu-progress');
        const dfuUploadBtn = document.getElementById('dfu-upload-btn');
        const dfuVerifyBtn = document.getElementById('dfu-verify-btn');
        const dfuResetBtn = document.getElementById('dfu-reset-btn');
        const dfuReceivedData = document.getElementById('dfu-received-data');
        const dfuGetStatusBtn = document.getElementById('dfu-get-status-btn');
        const dfuAbortBtn = document.getElementById('dfu-abort-btn');
        const dfuClearStatusBtn = document.getElementById('dfu-clear-status-btn');
        const dfuSendCommandBtn = document.getElementById('dfu-send-command-btn');
        
        // =============================================
        // DFU功能实现
        // =============================================
        
        // 检查浏览器是否支持WebUSB
        if (!navigator.usb) {
            dfuStatusText.textContent = "错误：您的浏览器不支持WebUSB API。请使用Chrome 89+或Edge 89+。";
            dfuStatusDot.classList.add('status-disconnected');
            dfuConnectBtn.disabled = true;
            dfuDetectBtn.disabled = true;
        }
        
        // DFU协议常量
        const DFU_CLASS = 0xFE;
        const DFU_SUBCLASS = 0x01;
        
        const DFU_REQ_DETACH = 0x00;
        const DFU_REQ_DNLOAD = 0x01;
        const DFU_REQ_UPLOAD = 0x02;
        const DFU_REQ_GETSTATUS = 0x03;
        const DFU_REQ_CLRSTATUS = 0x04;
        const DFU_REQ_GETSTATE = 0x05;
        const DFU_REQ_ABORT = 0x06;
        
        const DFU_STATUS_OK = 0x00;
        const DFU_STATUS_errTARGET = 0x01;
        const DFU_STATUS_errFILE = 0x02;
        const DFU_STATUS_errWRITE = 0x03;
        const DFU_STATUS_errERASE = 0x04;
        const DFU_STATUS_errCHECK_ERASED = 0x05;
        const DFU_STATUS_errPROG = 0x06;
        const DFU_STATUS_errVERIFY = 0x07;
        const DFU_STATUS_errADDRESS = 0x08;
        const DFU_STATUS_errNOTDONE = 0x09;
        const DFU_STATUS_errFIRMWARE = 0x0A;
        const DFU_STATUS_errVENDOR = 0x0B;
        const DFU_STATUS_errUSBR = 0x0C;
        const DFU_STATUS_errPOR = 0x0D;
        const DFU_STATUS_errUNKNOWN = 0x0E;
        const DFU_STATUS_errSTALLEDPKT = 0x0F;
        
        const DFU_STATE_appIDLE = 0x00;
        const DFU_STATE_appDETACH = 0x01;
        const DFU_STATE_dfuIDLE = 0x02;
        const DFU_STATE_dfuDNLOAD_SYNC = 0x03;
        const DFU_STATE_dfuDNBUSY = 0x04;
        const DFU_STATE_dfuDNLOAD_IDLE = 0x05;
        const DFU_STATE_dfuMANIFEST_SYNC = 0x06;
        const DFU_STATE_dfuMANIFEST = 0x07;
        const DFU_STATE_dfuMANIFEST_WAIT_RESET = 0x08;
        const DFU_STATE_dfuUPLOAD_IDLE = 0x09;
        const DFU_STATE_dfuERROR = 0x0A;
        
        // 连接DFU设备
        dfuConnectBtn.addEventListener('click', async () => {
            try {
                showNotification('正在请求DFU设备访问权限...', 'pending');
                updateDfuStatus('正在连接...', 'pending');
                
                const filters = [
                    { classCode: DFU_CLASS, subclassCode: DFU_SUBCLASS }
                ];
                
                dfuDevice = await navigator.usb.requestDevice({ filters });
                
                if (!dfuDevice) {
                    showNotification('未选择DFU设备', 'warning');
                    updateDfuStatus('未选择设备', 'disconnected');
                    return;
                }
                
                await dfuDevice.open();
                
                // 选择配置和接口
                const alternateSetting = parseInt(document.getElementById('dfu-interface-alt').value) || 0;
                dfuConfiguration = dfuDevice.configuration;
                
                // 查找DFU接口
                dfuInterface = null;
                for (const iface of dfuDevice.configuration.interfaces) {
                    const alternate = iface.alternates.find(a => 
                        a.interfaceClass === DFU_CLASS && 
                        a.interfaceSubclass === DFU_SUBCLASS
                    );
                    
                    if (alternate) {
                        await dfuDevice.claimInterface(iface.interfaceNumber);
                        dfuInterface = iface;
                        break;
                    }
                }
                
                if (!dfuInterface) {
                    throw new Error('未找到DFU接口');
                }
                
                // 更新设备信息
                dfuStatus.textContent = '已连接';
                dfuDeviceName.textContent = dfuDevice.productName || 'DFU设备';
                dfuVendorId.textContent = '0x' + dfuDevice.vendorId.toString(16).toUpperCase();
                dfuProductId.textContent = '0x' + dfuDevice.productId.toString(16).toUpperCase();
                
                // 获取DFU状态
                await getDfuStatus();
                
                showNotification(`已连接: ${dfuDevice.productName || 'DFU设备'}`, 'success');
                updateDfuStatus('已连接 - 准备就绪', 'connected');
                
            } catch (error) {
                console.error('DFU连接错误:', error);
                showNotification(`DFU连接失败: ${error.message}`, 'error');
                updateDfuStatus('连接失败', 'disconnected');
                
                if (dfuDevice && dfuDevice.opened) {
                    try {
                        await dfuDevice.close();
                    } catch (e) {
                        console.error('关闭DFU设备错误:', e);
                    }
                }
                
                dfuDevice = null;
                dfuInterface = null;
            }
        });
        
        // 断开DFU设备
        dfuDisconnectBtn.addEventListener('click', async () => {
            if (!dfuDevice) return;
            
            try {
                await dfuDevice.close();
                dfuDevice = null;
                dfuInterface = null;
                
                // 重置设备信息
                dfuStatus.textContent = '未连接';
                dfuDeviceName.textContent = '-';
                dfuVendorId.textContent = '-';
                dfuProductId.textContent = '-';
                
                showNotification('DFU设备已断开', 'info');
                updateDfuStatus('DFU设备已断开', 'disconnected');
                
            } catch (error) {
                console.error('断开DFU连接错误:', error);
                showNotification(`断开DFU连接失败: ${error.message}`, 'error');
            }
        });
        
        // 检测DFU模式
        dfuDetectBtn.addEventListener('click', async () => {
            try {
                showNotification('正在检测DFU设备...', 'pending');
                
                const devices = await navigator.usb.getDevices();
                const dfuDevices = devices.filter(device => {
                    return device.configuration?.interfaces.some(iface => {
                        return iface.alternates.some(alt => 
                            alt.interfaceClass === DFU_CLASS && 
                            alt.interfaceSubclass === DFU_SUBCLASS
                        );
                    });
                });
                
                if (dfuDevices.length > 0) {
                    showNotification(`找到 ${dfuDevices.length} 个DFU设备`, 'success');
                    
                    // 可以在这里自动连接第一个设备
                    // dfuDevice = dfuDevices[0];
                    // await dfuDevice.open();
                    // ... 其他连接逻辑
                    
                } else {
                    showNotification('未找到DFU设备', 'warning');
                }
                
            } catch (error) {
                console.error('检测DFU设备错误:', error);
                showNotification(`检测DFU设备失败: ${error.message}`, 'error');
            }
        });
        
        // 更新DFU状态显示
        function updateDfuStatus(text, status) {
            dfuStatusText.textContent = text;
            dfuStatusDot.className = 'status-dot';
            
            if (status === 'connected') {
                dfuStatusDot.classList.add('status-connected');
            } else if (status === 'disconnected') {
                dfuStatusDot.classList.add('status-disconnected');
            } else {
                dfuStatusDot.classList.add('status-pending');
            }
        }
        
        // 获取DFU状态
        async function getDfuStatus() {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                const result = await dfuDevice.controlTransferIn({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_REQ_GETSTATUS,
                    value: 0,
                    index: dfuInterface.interfaceNumber
                }, 6);
                
                if (result.data && result.data.byteLength >= 6) {
                    const status = result.data.getUint8(0);
                    const pollTimeout = result.data.getUint32(1, true) & 0xFFFFFF;
                    const state = result.data.getUint8(4);
                    const statusString = getDfuStatusString(status);
                    const stateString = getDfuStateString(state);
                    
                    dfuState = stateString;
                    
                    dfuReceivedData.textContent = `状态: ${statusString}\n超时: ${pollTimeout}ms\n状态: ${stateString}`;
                    
                    return {
                        status,
                        pollTimeout,
                        state
                    };
                }
                
            } catch (error) {
                console.error('获取DFU状态错误:', error);
                showNotification(`获取DFU状态失败: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // 清除DFU状态
        async function clearDfuStatus() {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                await dfuDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_REQ_CLRSTATUS,
                    value: 0,
                    index: dfuInterface.interfaceNumber
                });
                
                showNotification('DFU状态已清除', 'success');
                await getDfuStatus();
                
            } catch (error) {
                console.error('清除DFU状态错误:', error);
                showNotification(`清除DFU状态失败: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // 中止DFU操作
        async function abortDfu() {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                await dfuDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_REQ_ABORT,
                    value: 0,
                    index: dfuInterface.interfaceNumber
                });
                
                showNotification('DFU操作已中止', 'success');
                await getDfuStatus();
                
            } catch (error) {
                console.error('中止DFU操作错误:', error);
                showNotification(`中止DFU操作失败: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // 获取DFU状态字符串
        function getDfuStatusString(status) {
            const statusMap = {
                0x00: 'OK',
                0x01: 'errTARGET',
                0x02: 'errFILE',
                0x03: 'errWRITE',
                0x04: 'errERASE',
                0x05: 'errCHECK_ERASED',
                0x06: 'errPROG',
                0x07: 'errVERIFY',
                0x08: 'errADDRESS',
                0x09: 'errNOTDONE',
                0x0A: 'errFIRMWARE',
                0x0B: 'errVENDOR',
                0x0C: 'errUSBR',
                0x0D: 'errPOR',
                0x0E: 'errUNKNOWN',
                0x0F: 'errSTALLEDPKT'
            };
            
            return statusMap[status] || `未知状态 (0x${status.toString(16)})`;
        }
        
        // 获取DFU状态字符串
        function getDfuStateString(state) {
            const stateMap = {
                0x00: 'appIDLE',
                0x01: 'appDETACH',
                0x02: 'dfuIDLE',
                0x03: 'dfuDNLOAD_SYNC',
                0x04: 'dfuDNBUSY',
                0x05: 'dfuDNLOAD_IDLE',
                0x06: 'dfuMANIFEST_SYNC',
                0x07: 'dfuMANIFEST',
                0x08: 'dfuMANIFEST_WAIT_RESET',
                0x09: 'dfuUPLOAD_IDLE',
                0x0A: 'dfuERROR'
            };
            
            return stateMap[state] || `未知状态 (0x${state.toString(16)})`;
        }
        
        // 处理DFU文件选择
        dfuFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                dfuFile = file;
                dfuFileArrayBuffer = await file.arrayBuffer();
                
                dfuFileInfo.innerHTML = `
                    <div><strong>文件名:</strong> ${file.name}</div>
                    <div><strong>大小:</strong> ${file.size} 字节</div>
                    <div><strong>类型:</strong> ${file.type || '未知'}</div>
                `;
                
                showNotification(`已加载固件文件: ${file.name}`, 'success');
                
            } catch (error) {
                console.error('读取文件错误:', error);
                showNotification(`读取文件失败: ${error.message}`, 'error');
                dfuFile = null;
                dfuFileArrayBuffer = null;
            }
        });
        
        // 上传固件
        dfuUploadBtn.addEventListener('click', async () => {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            if (!dfuFile || !dfuFileArrayBuffer) {
                showNotification('错误：未选择固件文件', 'error');
                return;
            }
            
            try {
                showNotification('开始上传固件...', 'pending');
                updateDfuStatus('固件上传中...', 'pending');
                
                const flashAddress = parseInt(document.getElementById('dfu-flash-address').value, 16) || 0x08000000;
                const eraseType = document.getElementById('dfu-erase-type').value;
                dfuTransferSize = parseInt(document.getElementById('dfu-chunk-size').value) || 1024;
                
                // 设置地址指针
                await setDfuAddress(flashAddress);
                
                // 擦除Flash (如果需要)
                if (eraseType === 'full') {
                    await eraseDfuFull();
                } else if (eraseType === 'sector') {
                    await eraseDfuSectors(flashAddress, dfuFileArrayBuffer.byteLength);
                }
                
                // 分段上传固件
                const totalSize = dfuFileArrayBuffer.byteLength;
                let offset = 0;
                
                while (offset < totalSize) {
                    const chunkSize = Math.min(dfuTransferSize, totalSize - offset);
                    const chunk = new Uint8Array(dfuFileArrayBuffer, offset, chunkSize);
                    
                    await downloadDfuBlock(offset, chunk);
                    
                    offset += chunkSize;
                    dfuProgress = Math.floor((offset / totalSize) * 100);
                    dfuProgressBar.style.width = `${dfuProgress}%`;
                    dfuProgressBar.textContent = `${dfuProgress}%`;
                }
                
                // 完成下载
                await downloadDfuBlock(0, new Uint8Array(0));
                
                showNotification('固件上传完成', 'success');
                updateDfuStatus('固件上传完成', 'connected');
                
            } catch (error) {
                console.error('上传固件错误:', error);
                showNotification(`上传固件失败: ${error.message}`, 'error');
                updateDfuStatus('上传失败', 'disconnected');
            }
        });
        
        // 设置DFU地址
        async function setDfuAddress(address) {
            const addressBuffer = new ArrayBuffer(4);
            const addressView = new DataView(addressBuffer);
            addressView.setUint32(0, address, true);
            
            await dfuDevice.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_REQ_DNLOAD,
                value: 0,
                index: dfuInterface.interfaceNumber
            }, new Uint8Array([0x21, ...new Uint8Array(addressBuffer)]));
            
            await getDfuStatus();
        }
        
        // 全片擦除
        async function eraseDfuFull() {
            await dfuDevice.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_REQ_DNLOAD,
                value: 0,
                index: dfuInterface.interfaceNumber
            }, new Uint8Array([0x41]));
            
            await getDfuStatus();
            showNotification('Flash全片擦除完成', 'success');
        }
        
        // 按扇区擦除
        async function eraseDfuSectors(startAddress, length) {
            // 这里需要根据具体芯片的扇区分布来实现
            // 简化版: 假设每2KB一个扇区
            const sectorSize = 2048;
            const sectors = Math.ceil(length / sectorSize);
            
            for (let i = 0; i < sectors; i++) {
                const sectorAddress = startAddress + i * sectorSize;
                await setDfuAddress(sectorAddress);
                
                await dfuDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_REQ_DNLOAD,
                    value: 0,
                    index: dfuInterface.interfaceNumber
                }, new Uint8Array([0x41]));
                
                await getDfuStatus();
            }
            
            showNotification(`已擦除 ${sectors} 个扇区`, 'success');
        }
        
        // 下载DFU块
        async function downloadDfuBlock(blockNumber, data) {
            await dfuDevice.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_REQ_DNLOAD,
                value: blockNumber + 2,
                index: dfuInterface.interfaceNumber
            }, data);
            
            await getDfuStatus();
        }
        
        // 验证固件
        dfuVerifyBtn.addEventListener('click', async () => {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                showNotification('开始验证固件...', 'pending');
                updateDfuStatus('验证中...', 'pending');
                
                // 这里需要根据具体芯片实现验证逻辑
                // 简化版: 读取部分数据验证
                const verifySize = Math.min(1024, dfuFileArrayBuffer.byteLength);
                const flashData = await uploadDfuData(0, verifySize);
                
                const fileData = new Uint8Array(dfuFileArrayBuffer, 0, verifySize);
                const isMatch = compareArrays(flashData, fileData);
                
                if (isMatch) {
                    showNotification('固件验证成功', 'success');
                    updateDfuStatus('验证成功', 'connected');
                } else {
                    showNotification('固件验证失败: 数据不匹配', 'error');
                    updateDfuStatus('验证失败', 'disconnected');
                }
                
            } catch (error) {
                console.error('验证固件错误:', error);
                showNotification(`验证固件失败: ${error.message}`, 'error');
                updateDfuStatus('验证失败', 'disconnected');
            }
        });
        
        // 上传DFU数据 (读取)
        async function uploadDfuData(blockNumber, length) {
            const result = await dfuDevice.controlTransferIn({
                requestType: 'class',
                recipient: 'interface',
                request: DFU_REQ_UPLOAD,
                value: blockNumber,
                index: dfuInterface.interfaceNumber,
                length: length
            });
            
            await getDfuStatus();
            return new Uint8Array(result.data.buffer);
        }
        
        // 比较两个数组
        function compareArrays(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // 复位设备
        dfuResetBtn.addEventListener('click', async () => {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                await dfuDevice.controlTransferOut({
                    requestType: 'class',
                    recipient: 'interface',
                    request: DFU_REQ_DETACH,
                    value: 0,
                    index: dfuInterface.interfaceNumber
                });
                
                showNotification('设备复位命令已发送', 'success');
                updateDfuStatus('等待设备复位...', 'pending');
                
                // 关闭连接
                await dfuDevice.close();
                dfuDevice = null;
                dfuInterface = null;
                
                // 重置设备信息
                dfuStatus.textContent = '未连接';
                dfuDeviceName.textContent = '-';
                dfuVendorId.textContent = '-';
                dfuProductId.textContent = '-';
                
                updateDfuStatus('设备应已复位', 'disconnected');
                
            } catch (error) {
                console.error('复位设备错误:', error);
                showNotification(`复位设备失败: ${error.message}`, 'error');
            }
        });
        
        // 绑定DFU命令按钮
        dfuGetStatusBtn.addEventListener('click', getDfuStatus);
        dfuClearStatusBtn.addEventListener('click', clearDfuStatus);
        dfuAbortBtn.addEventListener('click', abortDfu);
        
        // 发送DFU命令
        dfuSendCommandBtn.addEventListener('click', async () => {
            if (!dfuDevice || !dfuInterface) {
                showNotification('错误：DFU设备未连接', 'error');
                return;
            }
            
            try {
                const command = parseInt(document.getElementById('dfu-command').value) || 0;
                const hexData = document.getElementById('dfu-command-data').value;
                const data = hexData.trim() ? hexToBytes(hexData) : new Uint8Array(0);
                
                let result;
                
                if (command === DFU_REQ_UPLOAD) {
                    // 上传命令 (读取)
                    result = await dfuDevice.controlTransferIn({
                        requestType: 'class',
                        recipient: 'interface',
                        request: command,
                        value: 0,
                        index: dfuInterface.interfaceNumber,
                        length: data.length || 64
                    });
                    
                    dfuReceivedData.textContent = `响应数据: ${bytesToHex(new Uint8Array(result.data.buffer))}`;
                    
                } else {
                    // 其他命令 (写入)
                    result = await dfuDevice.controlTransferOut({
                        requestType: 'class',
                        recipient: 'interface',
                        request: command,
                        value: 0,
                        index: dfuInterface.interfaceNumber
                    }, data);
                    
                    dfuReceivedData.textContent = `命令已发送`;
                }
                
                // 获取最新状态
                await getDfuStatus();
                
                showNotification('DFU命令执行成功', 'success');
                
            } catch (error) {
                console.error('发送DFU命令错误:', error);
                showNotification(`发送DFU命令失败: ${error.message}`, 'error');
                dfuReceivedData.textContent = `错误: ${error.message}`;
            }
        });
        
        // 初始化
        updateDfuStatus('准备连接DFU设备...', 'disconnected');
        
        // ... (保留之前的其他代码)
    </script>
</body>
</html>
